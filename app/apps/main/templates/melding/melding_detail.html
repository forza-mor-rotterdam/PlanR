{% extends "base.html" %}
{% load vind_in_dict from querystring_tags %}
{% load to_datetime from date_tags %}
{% load rotterdam_formulier_html %}
{% load vertaal from vertaal_tags %}
{% load slice_iterable python_any from main_tags %}
{% load get_gebruiker_object_middels_email from gebruikers_tags %}
{% load render_onderwerp render_categorie get_bijlagen melding_taken from melding_tags %}
{% load json_encode from json_tags %}
{% block title %}
    Melding
    {% for signaal in melding.signalen_voor_melding %}
        {{ signaal.bron_signaal_id }}
        {% if forloop.last == false %}
            ,
        {% else %}
            |
        {% endif %}
    {% endfor %}
    {{ melding.id }} | PlanR
{% endblock title %}
{% block header %}
    {% with pageTitle="Meldingen" %}
        {% include "snippets/pageheader.html" %}
    {% endwith %}
{% endblock header %}
{% block body_class %}
    has-page-navigation
{% endblock body_class %}
{% block body %}
    <turbo-frame id="overview">
        {% if not melding.error %}
            {% get_bijlagen melding as bijlagen %}
            {% with melding.meldinggebeurtenissen|last as laatste_meldinggebeurtenis %}
            {% with signalen=melding.signalen_voor_melding %}
                <div data-controller="detail sidesheet"
                    data-detail-locaties-value="{{ locaties.adressen|json_encode }}"
                    data-detail-afbeeldingen-value="{{ bijlagen|json_encode }}"
                    data-detail-url-prefix-value="{{ MOR_CORE_URL_PREFIX }}"
                    data-detail-signalen-value="{{ melding.signalen_voor_melding|json_encode }}"
                    data-action="detailHeaderChange@window->detail#setHeaderHeight"
                    class="detail-content-wrapper">
                    <div class="border-green print-only"></div>
                    {% if melding.uuid %}
                        <div class="page__detail">
                            <div id="id_maincontent">
                                <div class="container__header stayfixed" data-detail-target="containerActions">
                                    <div class="item">
                                        <a href="{% url 'melding_lijst' %}"
                                        data-turbo-action='advance'
                                        class="link--back">
                                            {% include "icons/arrow-short.svg" %}
                                            Terug
                                        </a>
                                        {% include "melding/melding_gebruiker_actief.html" %}
                                        <div id="melding_detail_titel">
                                             {% include "melding/detail/melding_detail_titel.html" %}
                                        </div>
                                    </div>
                                    <div class="item aside">
                                        <div class="container__actions" data-detail-target="containerActions">
                                            <div class="wrapper">
                                                <div class="container__meldingnavigatie">
                                                    {% if meldingen_index %}
                                                        <span class="help-text">{{ meldingen_index }} van {{ request.session.melding_count }}</span>
                                                        <div class="container__buttons">
                                                            <turbo-frame style="display: inline;" id="melding_next_vorige" src="{% url 'melding_next_vorige' melding.uuid %}" data-spinner="hide"></turbo-frame>
                                                            <turbo-frame style="display: inline;" id="melding_next_volgend" src="{% url 'melding_next_volgend' melding.uuid %}" data-spinner="hide"></turbo-frame>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div id="melding_detail_acties">
                                                    {% include "melding/detail/acties.html" with disable_stream=True %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="stream_melding_detail_status">
                                    {% include "melding/detail/status.html" %}
                                </div>
                                <div id="melding_detail_taken">
                                    {% include "melding/detail/taken.html" %}
                                </div>
                                {% include "melding/melding_detail_locaties_lichtmasten.html" with locaties=type_locaties melding=melding lichtmasten=locaties.lichtmasten only %}
                                <div class="grid-container grid-container--half">
                                    <div class="grid-item">
                                        <section class="section--separated" data-testid="detailMelding">
                                            <div class="container__details melding">
                                                <h2>Meldingdetails</h2>
                                                <div>
                                                    {% if melding.signalen_voor_melding|length > 1 %}
                                                        <div class="container__tabs">
                                                            <h3 class="h6">Samengevoegde melding</h3>
                                                            <ul class="list-tabs">
                                                                {% for signaal in melding.signalen_voor_melding %}
                                                                    <li>
                                                                        <button class="btn btn--tab" data-tab-index="{{ forloop.counter }}" data-detail-target="tabButton" data-action="detail#tabButtonClickHandler" data-detail-tab-index-param="{{ forloop.counter }}">
                                                                            {% if signaal.bron_signaal_id|length > 8 %}
                                                                                ...{% slice_iterable signaal.bron_signaal_id -6 None %}
                                                                            {% else %}
                                                                                {{ signaal.bron_signaal_id }}
                                                                            {% endif %}
                                                                        </button>
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    {% endif %}
                                                        <div class="container__tab-content">
                                                            {% for signaal in melding.signalen_voor_melding %}
                                                                <div class="tab-content{% if forloop.counter == 1 %} active{% endif %}" data-tab-index="{{ forloop.counter }}" {% if melding.signalen_voor_melding|length > 1 %}data-detail-target="tabContent"{% endif %}>
                                                                    <div class="has-background--white">
                                                                        <dl>
                                                                            <div>
                                                                                <dt>Melding aangemaakt</dt>
                                                                                <dd>
                                                                                    {% if signaal.origineel_aangemaakt %}
                                                                                        {{ signaal.origineel_aangemaakt|to_datetime|date:"d-m-Y H:i" }}
                                                                                    {% else %}
                                                                                        -
                                                                                    {% endif %}
                                                                                </dd>
                                                                            </div>
                                                                            <div>
                                                                                <dt>Categorie</dt>
                                                                                <dd>
                                                                                    {% for onderwerp in melding.onderwerpen %}
                                                                                        {% render_categorie onderwerp %}
                                                                                        {% if not forloop.last %},{% endif %}
                                                                                    {% endfor %}
                                                                                </dd>
                                                                            </div>
                                                                            <div>
                                                                                <dt>Onderwerp</dt>
                                                                                <dd>
                                                                                    {% for onderwerp in melding.onderwerpen %}
                                                                                        {% render_onderwerp onderwerp %}
                                                                                        {% if not forloop.last %},{% endif %}
                                                                                    {% endfor %}
                                                                                </dd>
                                                                            </div>
                                                                            {% if signaal.omschrijving_melder %}
                                                                            <div>
                                                                                <dt>Omschrijving</dt>
                                                                                <dd>
                                                                                    {{ signaal.omschrijving_melder }}
                                                                                </dd>
                                                                            </div>
                                                                            {% endif %}
                                                                            {% with aanvullende_vragen=signaal.aanvullende_vragen %}
                                                                                {% if aanvullende_vragen %}
                                                                                    {% for qa in aanvullende_vragen %}
                                                                                        {% if qa.answers|python_any %}
                                                                                            <div>
                                                                                                <dt>{{ qa.question }}</dt>
                                                                                                <dd>
                                                                                                    {% for answer in qa.answers %}
                                                                                                        {{ answer }}
                                                                                                        {% if not forloop.last %},{% endif %}
                                                                                                    {% endfor %}
                                                                                                </dd>
                                                                                            </div>
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                {% elif signaal.aanvullende_informatie %}
                                                                                    <div>
                                                                                        <dt>Aanvullende informatie</dt>
                                                                                        <dd>
                                                                                            {{ signaal.aanvullende_informatie }}
                                                                                        </dd>
                                                                                    </div>
                                                                                {% endif %}
                                                                            {% endwith %}
                                                                        </dl>
                                                                        <dl>
                                                                            <div>
                                                                                <dt>{{ signaal.bron_id }}-nummer</dt>
                                                                                <dd>
                                                                                    {% if signaal.bron_signaal_id %}
                                                                                        {{ signaal.bron_signaal_id }}
                                                                                    {% else %}
                                                                                        -
                                                                                    {% endif %}
                                                                                </dd>
                                                                            </div>
                                                                            <div>
                                                                                <dt>Meldingsnummer</dt>
                                                                                <dd>
                                                                                    {{ melding.id }}
                                                                                </dd>
                                                                            </div>
                                                                        </dl>
                                                                        {% if signaal.melder.naam or signaal.melder.voornaam or signaal.melder.achternaam or signaal.melder.telefoonnummer or signaal.melder.email %}
                                                                        <dl>
                                                                            {% if signaal.melder.naam or signaal.melder.voornaam or signaal.melder.achternaam %}
                                                                            <div>
                                                                                <dt>Melder</dt>
                                                                                <dd>
                                                                                    {% if signaal.melder.naam %}
                                                                                    {{ signaal.melder.naam }}
                                                                                    {% elif signaal.melder.voornaam or signaal.melder.achternaam %}
                                                                                    {% if signaal.melder.voornaam %}{{ signaal.melder.voornaam }} {% endif %}{% if signaal.melder.achternaam %}{{ signaal.melder.achternaam }} {% endif %}
                                                                                    {% else %}
                                                                                    -
                                                                                    {% endif %}
                                                                                </dd>
                                                                            </div>
                                                                            {% endif %}
                                                                            {% if signaal.melder.telefoonnummer %}
                                                                            <div>
                                                                                <dt>Telefoonnummer</dt>
                                                                                <dd>
                                                                                    <a href="tel:{{ signaal.melder.telefoonnummer }}" class="link--phone">{{ signaal.melder.telefoonnummer }}</a>
                                                                                </dd>
                                                                            </div>
                                                                            {% endif %}
                                                                            {% if signaal.melder.email %}
                                                                            <div>
                                                                                <dt>E-mail</dt>
                                                                                <dd>
                                                                                    <a href="mailto:{{ signaal.melder.email }}" class="link--email">{{ signaal.melder.email }}</a>
                                                                                </dd>
                                                                            </div>
                                                                            {% endif %}
                                                                        </dl>
                                                                        {% endif %}
                                                                        {% if signaal.meta.specifiek_graf or signaal.meta.terugkoppeling_gewenst or signaal.meta.aannemer %}
                                                                        <dl>
                                                                            {% if signaal.meta.aannemer %}
                                                                                <div>
                                                                                    <dt>Aangenomen door</dt>
                                                                                    <dd>
                                                                                        {{ signaal.meta.aannemer }}
                                                                                    </dd>
                                                                                </div>
                                                                            {% endif %}
                                                                            {% if signaal.meta.specifiek_graf == "Ja" %}
                                                                                <div>
                                                                                    <dt>Is deze persoon de rechthebbende?</dt>
                                                                                    <dd>
                                                                                        {{ signaal.meta.rechthebbende }}
                                                                                    </dd>
                                                                                </div>
                                                                            {% endif %}
                                                                            <div>
                                                                                <dt>Is terugkoppeling gewenst?</dt>
                                                                                <dd>
                                                                                    {{ signaal.meta.terugkoppeling_gewenst }}
                                                                                </dd>
                                                                            </div>
                                                                        </dl>
                                                                        {% endif %}
                                                                        {% if signaal.kanaal or laatste_meldinggebeurtenis.gebruiker %}
                                                                        <dl>
                                                                            {% if signaal.kanaal %}
                                                                            <div>
                                                                                <dt>Kanaal</dt>
                                                                                <dd>
                                                                                    {{ signaal.kanaal }}
                                                                                </dd>
                                                                            </div>
                                                                            {% endif %}
                                                                            {% if laatste_meldinggebeurtenis.gebruiker %}
                                                                            <div>
                                                                                <dt>Medewerker</dt>
                                                                                <dd>
                                                                                    {% with gebruiker_object=laatste_meldinggebeurtenis.gebruiker|get_gebruiker_object_middels_email %}
                                                                                    <a href="" data-action="modal#openModal" data-modal-action-param="{% url 'gebruiker_info' gebruiker_email=laatste_meldinggebeurtenis.gebruiker %}">{{ gebruiker_object.full_name }}</a>
                                                                                    {% endwith %}
                                                                                </dd>
                                                                            </div>
                                                                            {% endif %}
                                                                        </dl>
                                                                        {% endif %}
                                                                        {% if perms.authorisatie.beheer_bekijken %}
                                                                        <dl>
                                                                            <div>
                                                                                <dt>Versie</dt>
                                                                                <dd>
                                                                                    {% if signaal.versie %}{{ signaal.versie }}{% else %}-{% endif %}
                                                                                </dd>
                                                                            </div>
                                                                        </dl>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                </div>
                                            </div>
                                        </section>
                                        {% include "melding/melding_detail_locaties.html" %}
                                        <div class="border-green print-only"></div>
                                    </div>
                                    <div class="grid-item aside">
                                        <section class="section--separated">
                                            {% if bijlagen|length > 0 %}
                                                <div class="container__details" data-detail-target="imageSliderWidth">
                                                    <h2>Foto's</h2>
                                                    {% include "melding/detail/bijlagen.html" with bijlagen=bijlagen only %}
                                                </div>
                                            {% endif %}
                                        </section>
                                        {% if melding.signalen_voor_melding|length > 1 %}
                                            <div class="alert alert--info">
                                                <span>
                                                    <svg width="24"
                                                            height="24"
                                                            viewBox="0 0 24 24"
                                                            fill="none"
                                                            xmlns="http://www.w3.org/2000/svg">
                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M21.9 12C21.9 6.5 17.5 2.1 12 2.1C6.5 2.1 2.1 6.5 2.1 12C2.1 17.5 6.5 21.9 12 21.9C17.5 21.9 21.9 17.5 21.9 12ZM0 12C0 5.4 5.4 0 12 0C18.6 0 24 5.4 24 12C24 18.6 18.6 24 12 24C5.4 24 0 18.6 0 12ZM13 7V5H11V7H13ZM13 19V9H11V19H13Z" fill="#00689E" />
                                                    </svg>
                                                </span>
                                                <span>Melding samengevoegd met:
                                                    {% for signaal in melding.signalen_voor_melding %}
                                                        {{ signaal.bron_signaal_id }}
                                                        {% if not forloop.last %},{% endif %}
                                                    {% endfor %}
                                                </span>
                                            </div>
                                        {% endif %}
                                        <section class="section--separated">
                                            <div class="container__details">
                                                {% if melding.status.naam != "afgehandeld" and melding.status.naam != "geannuleerd" %}
                                                    <h2>Notities en foto's</h2>
                                                    <turbo-frame id="informatie_toevoegen" src="{% url 'informatie_toevoegen' melding.uuid %}">
                                                    </turbo-frame>
                                                {% endif %}
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                            <button data-detail-target="btnToTop"
                                    data-action="detail#scrollToTop"
                                    class="btn btn-to-top">
                                {% include "icons/arrow-right-v2.svg" %}
                            </button>
                        </div>
                    {% endif %}
                </div>
            {% endwith %}
            {% endwith %}
        {% endif %}
    </turbo-frame>
{% endblock body %}
